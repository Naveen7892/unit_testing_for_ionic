<!DOCTYPE html>
<!-- saved from url=(0044)http://cgewecke.github.io/ionic-karma-guide/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   
   <meta name="google-site-verification" content="sz6-ll3FGubc4eKR6PbWybQrWLfRjg1Yt1l6ImrvUI8">
   <title>Ionic/Karma Guide</title>
   <link rel="stylesheet" type="text/css" href="./Ionic_Karma Guide_files/style.css">
   <link rel="stylesheet" href="./Ionic_Karma Guide_files/gh-fork-ribbon.min.css">
   <link rel="alternate" type="application/atom+xml" href="http://cgewecke.github.io/ionic-karma-guide/feed.xml" title="News Feed">
   <link rel="shortcut icon" type="image/png" href="http://cgewecke.github.io/ionic-karma-guide/favicon.png">

   <script async="" src="./Ionic_Karma Guide_files/analytics.js.download"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74663783-1', 'auto');
  ga('send', 'pageview');

  </script>
</head>
<body>
<a class="github-fork-ribbon" href="https://github.com/cgewecke/ionic-karma-guide" title="Source on GitHub">Source on GitHub</a>
<div class="container">
<header class="masthead">
   <h3 class="masthead-title">
     <a href="https://github.com/cgewecke">Ionic/Karma Guide</a>
   </h3>
</header>

<div id="content">
  

<article class="post">
  <h1 class="post-title">
    <a href="http://cgewecke.github.io/ionic-karma-guide/ionickarma.html">
      A Short Guide to Testing Ionic App Templates &amp; Directives
    </a>
  </h1>
  <div class="post-date">Mar 3, 2016</div>
  <h3 id="using-karma-for-quick-low-level-integration-testing">Using Karma for quick low-level integration testing</h3>
<p>This guide follows <a href="https://github.com/vojtajina/ng-directive-testing">Volta Jina’s approach</a> to Angular testing, where Karma specs are written for logic embedded in the templates and validation is done by checking element behavior. Some nice examples of this strategy can be found at the <a href="https://github.com/angular/material/blob/master/src/components/button/button.spec.js">Angular Material</a> project.</p>

<p>We will be using the <a href="http://ionicframework.com/docs/cli/start.html">ionic ‘tabs’ starter</a> as a base. Testing Ionic apps has its idiosyncrasies: ui-router and ionicTemplateCache trigger lots of ‘unexpected request’ errors from the test runner - in fact <a href="https://github.com/angular-ui/ui-router/issues/212#issuecomment-69974072">it’s common practice to disable them</a>. This means accessing templates and their controllers requires some extra steps. We’ll walk through these, write tests for a tab view and then look at a directive that uses cordova plugins.</p>

<h3 id="table-of-contents">Table of Contents</h3>

<p><a href="http://cgewecke.github.io/ionic-karma-guide/#setup">Setting up the test environment</a> <br>
<a href="http://cgewecke.github.io/ionic-karma-guide/#chatsctrl">Testing a controller and its template</a> <br>
<a href="http://cgewecke.github.io/ionic-karma-guide/#cordova">Testing a directive that uses cordova plugins</a></p>

<h2 id="a-namesetupa-the-test-environment"><a name="setup"></a> The Test Environment</h2>
<hr>

<p><a href="http://karma-runner.github.io/0.13/intro/installation.html">karma</a>: the test runner  <br>
<a href="https://github.com/karma-runner/karma-jasmine">jasmine</a>: the testing framework  <br>
<a href="https://github.com/karma-runner/karma-chrome-launcher">chrome-launcher</a>: for event and debugging support (instead of phantom.js)  <br>
<a href="https://github.com/karma-runner/karma-ng-html2js-preprocessor">ng-html2js-preprocessor</a>: to consume templates as javascript strings <br>
<a href="https://www.npmjs.com/package/karma-mocha-reporter">mocha-reporter</a>: for nice test reports.  <br>
<a href="https://www.npmjs.com/package/jquery">jQuery</a>: for finding elements.  <br>
<a href="https://docs.angularjs.org/api/ngMock">angular-mocks</a>: for mocking services like $timeout and $http</p>

<p><em>(None of these packages will ship with your app - they are part of the development environment)</em></p>

<p>At the command line in your project directory run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>npm install karma --save-dev
<span class="gp">$ </span>npm install -g karma-cli
<span class="gp">$ </span>npm install jasmine-core --save-dev
<span class="gp">$ </span>npm install karma-jasmine@2_0 --save-dev
<span class="gp">$ </span>npm install karma-chrome-launcher --save-dev
<span class="gp">$ </span>npm install karma-ng-html2js-preprocessor --save-dev
<span class="gp">$ </span>npm install karma-mocha-reporter --save-dev
<span class="gp">$ </span>npm install jquery --save-dev
<span class="gp">$ </span>bower install angular-mocks --save-dev</code></pre></figure>

<p>Create a karma config file by running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>karma init</code></pre></figure>

<p>Karma  will ask you a series of questions about which frameworks to use (jasmine), what browsers to launch (chrome) and what files to watch. Skip through this, pressing return after everything. There’s a section below on modifying the config file manually once it’s generated.</p>

<p>Add the following task to your project’s gulpfile.js:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'karma'</span><span class="p">).</span><span class="nx">Server</span><span class="p">;</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'test'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">new</span> <span class="nx">Server</span><span class="p">({</span>
    <span class="na">configFile</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/karma.conf.js'</span><span class="p">,</span>
    <span class="na">singleRun</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span> <span class="nx">done</span><span class="p">).</span><span class="nx">start</span><span class="p">()</span>
<span class="p">});</span></code></pre></figure>

<p>Ultimately, when you’re ready to test you’ll run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>gulp <span class="nb">test</span></code></pre></figure>

<h3 id="make-some-folders-for-your-tests">Make some folders for your tests</h3>

<p>(Or think about where to put them).</p>

<p>You could, for example, run the following in the project’s root directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>mkdir tests
<span class="gp">$ </span>mkdir tests/controllers
<span class="gp">$ </span>mkdir tests/directives
<span class="gp">$ </span>mkdir tests/services</code></pre></figure>

<p>There is another, perhaps better strategy <a href="https://github.com/johnpapa/angular-styleguide/blob/master/a1/README.md#style-y197">advocated by John Papa</a> which says you should store tests alongside their targets - i.e maintain a directory structure like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">|-- Controllers
|   |-- SomeCtrl.js
|   |-- SomeCtrl.spec.js
|   |-- AnotherCtrl.js
|   |-- AnotherCtrl.spec.js</code></pre></figure>

<p>The idea here is that the tests are an integral part of the code and should be kept close at hand. This project is small and doesn’t have much directory structure so we’ll just put our tests in a dedicated folder.</p>

<h3 id="edit-karmaconfigjs">Edit karma.config.js</h3>
<p>(The full config for this project can be found <a href="https://github.com/cgewecke/ionic-karma-guide/blob/master/karma-guide/karma.conf.js">here</a>.)</p>

<p>List jQuery <strong>first</strong> in the files array, <em>then</em> the ionic bundle and other lib files, <em>then</em> your html files, <em>then</em> any other js files you’ve declared in index.html and your test files.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">files</span><span class="p">:</span> <span class="p">[</span>
   
   <span class="s">'node_modules/jquery/dist/jquery.min.js'</span><span class="p">,</span>
   <span class="s">'www/lib/ionic/js/ionic.bundle.js'</span><span class="p">,</span>
   <span class="s">'www/lib/angular-mocks/angular-mocks.js'</span><span class="p">,</span> 
   <span class="o">...</span>
   <span class="s">'www/templates/*.html'</span>
   <span class="o">...</span>
   <span class="s">'www/js/app.js'</span><span class="p">,</span>
   <span class="s">'www/js/addContact.js'</span><span class="p">,</span>
   <span class="s">'www/js/controllers.js'</span><span class="p">,</span>
   <span class="s">'www/js/services.js'</span><span class="p">,</span>
   <span class="o">...</span>    
   <span class="s">'tests/*.js'</span>
<span class="p">],</span>        </code></pre></figure>

<p>Define your custom launcher, enumerate your plugins, specify your pre-processors, and select your reporter, as below.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">customLaunchers</span><span class="p">:</span> <span class="p">{</span>
  <span class="n">Chrome_without_security</span><span class="p">:</span> <span class="p">{</span>
     <span class="n">base</span><span class="p">:</span> <span class="s">'Chrome'</span><span class="p">,</span>
     <span class="n">flags</span><span class="p">:</span> <span class="p">[</span><span class="s">'--disable-web-security'</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>

<span class="n">plugins</span><span class="p">:</span> <span class="p">[</span>
  <span class="s">"karma-chrome-launcher"</span><span class="p">,</span>
  <span class="s">"karma-jasmine"</span><span class="p">,</span>
  <span class="s">"karma-mocha-reporter"</span><span class="p">,</span>
  <span class="s">"karma-ng-html2js-preprocessor"</span>
<span class="p">],</span>

<span class="n">preprocessors</span><span class="p">:</span> <span class="p">{</span>
  <span class="s">'www/templates/*.html'</span><span class="p">:</span> <span class="p">[</span><span class="s">'ng-html2js'</span><span class="p">]</span>
<span class="p">},</span>

<span class="n">ngHtml2JsPreprocessor</span><span class="p">:</span> <span class="p">{</span>
   <span class="n">moduleName</span><span class="p">:</span> <span class="s">'templates'</span><span class="p">,</span>
   <span class="n">stripPrefix</span><span class="p">:</span> <span class="s">'www/'</span>
<span class="p">},</span>

<span class="n">reporters</span><span class="p">:</span> <span class="p">[</span><span class="s">'mocha'</span><span class="p">],</span></code></pre></figure>

<p>Now Karma will launch in chrome, pre-cache your templates (to avoid router calls) and print intelligible color-coded reports. Lets write some tests.</p>

<h2 id="a-namechatsctrla-testing-chatsctrl"><a name="chatsctrl"></a> Testing ChatsCtrl</h2>
<hr>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'ChatsCtrl'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Chats</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$scope</span><span class="p">.</span><span class="nx">chats</span> <span class="o">=</span> <span class="nx">Chats</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
  <span class="nx">$scope</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Chats</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">});</span></code></pre></figure>

<p>That’s ChatsCtrl: an archetypically ‘thin’ controller whose sole purpose is to expose service methods to the DOM on $scope. A traditional unit test for it looks like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">'ChatsCtrl'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="kd">var</span> <span class="nx">$scope</span><span class="p">,</span> <span class="nx">$controller</span><span class="p">,</span> <span class="nx">Chats</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">;</span>

    <span class="c1">// Load app</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'starter'</span><span class="p">));</span>

    <span class="c1">// Inject services and spin up the controller</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_$rootScope_</span><span class="p">,</span> <span class="nx">_$controller_</span><span class="p">,</span> <span class="nx">_Chats_</span><span class="p">){</span>
        
        <span class="nx">$scope</span> <span class="o">=</span> <span class="nx">_$rootScope_</span><span class="p">;</span>
        <span class="nx">$controller</span> <span class="o">=</span> <span class="nx">_$controller_</span><span class="p">;</span>
        <span class="nx">Chats</span> <span class="o">=</span> <span class="nx">_Chats_</span><span class="p">;</span>

        <span class="nx">ctrl</span> <span class="o">=</span> <span class="nx">$controller</span><span class="p">(</span><span class="s1">'ChatsCtrl'</span><span class="p">,</span> <span class="p">{</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Chats</span><span class="p">});</span>

    <span class="p">}));</span>

    <span class="c1">// Tests</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">'should bind all chats to the scope'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">chats</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">Chats</span><span class="p">.</span><span class="nx">all</span><span class="p">());</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">'should have a remove method that wraps Chats.remove'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        
        <span class="kd">var</span> <span class="nx">chat</span> <span class="o">=</span> <span class="p">{</span> <span class="na">sender</span><span class="p">:</span> <span class="s1">'me'</span><span class="p">,</span> <span class="na">receiver</span><span class="p">:</span> <span class="s1">'you'</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'hi!'</span><span class="p">};</span>
        <span class="nx">spyOn</span><span class="p">(</span><span class="nx">Chats</span><span class="p">,</span> <span class="s1">'remove'</span><span class="p">);</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>

        <span class="nx">expect</span><span class="p">(</span><span class="nx">Chats</span><span class="p">.</span><span class="nx">remove</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">chat</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<p>We also want tests that describe the way the controller is wired into the html since that’s where most of the logic actually gets expressed. Here’s the template: it ng-repeats a list. Each item is ng-clickable and has a dynamically generated link.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ion-view</span> <span class="na">view-title=</span><span class="s">"Chats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ion-content&gt;</span>
    <span class="nt">&lt;ion-list&gt;</span>
      <span class="nt">&lt;ion-item</span> <span class="na">class=</span><span class="s">"etc"</span> <span class="na">ng-repeat=</span><span class="s">"chat in chats"</span> <span class="na">href=</span><span class="s">"#/tab/chats/{{chat.id}}"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;img</span> <span class="na">ng-src=</span><span class="s">"{{chat.face}}"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon ion-chevron-right icon-accessory"</span><span class="nt">&gt;&lt;/i&gt;</span>

        <span class="nt">&lt;ion-option-button</span> <span class="na">class=</span><span class="s">"button-assertive"</span> <span class="na">ng-click=</span><span class="s">"remove(chat)"</span><span class="nt">&gt;</span>
          Delete
        <span class="nt">&lt;/ion-option-button&gt;</span>
      <span class="nt">&lt;/ion-item&gt;</span>
    <span class="nt">&lt;/ion-list&gt;</span>
  <span class="nt">&lt;/ion-content&gt;</span>
<span class="nt">&lt;/ion-view&gt;</span></code></pre></figure>

<p>And the test set up:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">'tab-chats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="c1">// Locals</span>
    <span class="kd">var</span> <span class="nx">$scope</span><span class="p">,</span> <span class="nx">$compile</span><span class="p">,</span> <span class="nx">$templateCache</span><span class="p">,</span> <span class="nx">compileProvider</span><span class="p">,</span> <span class="nx">Chats</span><span class="p">,</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">ctrl</span><span class="p">;</span>

    <span class="c1">// Load app &amp; ng-html2js pre-processed templates</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'starter'</span><span class="p">));</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'templates'</span><span class="p">));</span>

    <span class="c1">// Inject $compileProvider</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$compileProvider</span><span class="p">)</span> <span class="p">{</span>   
        <span class="nx">compileProvider</span> <span class="o">=</span> <span class="nx">$compileProvider</span><span class="p">;</span>
    <span class="p">}));</span>

    <span class="c1">// Inject services, </span>
    <span class="c1">// Spin up the template as a directive with ChatsCtrl as its controller</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_$rootScope_</span><span class="p">,</span> <span class="nx">_$compile_</span><span class="p">,</span> <span class="nx">_Chats_</span><span class="p">){</span>
        
        <span class="nx">$scope</span> <span class="o">=</span> <span class="nx">_$rootScope_</span><span class="p">;</span>
        <span class="nx">$compile</span> <span class="o">=</span> <span class="nx">_$compile_</span><span class="p">;</span>
        <span class="nx">Chats</span> <span class="o">=</span> <span class="nx">_Chats_</span><span class="p">;</span>

        <span class="c1">// Behind the scenes, templateUrl will grab the template from $templateCache</span>
        <span class="nx">compileProvider</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">'chatsCtrlTest'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="na">controller</span><span class="p">:</span> <span class="s1">'ChatsCtrl'</span><span class="p">,</span>
                <span class="na">templateUrl</span><span class="p">:</span><span class="s1">'templates/tab-chats.html'</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Compile it and bind to $scope.</span>
        <span class="nx">template</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="s1">'&lt;chats-ctrl-test&gt;&lt;/chats-ctrl-test&gt;'</span><span class="p">);</span>
        <span class="nx">$compile</span><span class="p">(</span><span class="nx">template</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">);</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

        <span class="c1">// If the Ionic starter app used 'controller as' syntax and bound its </span>
        <span class="c1">// variables to 'this', we could get the controller instance like this:</span>
        <span class="nx">ctrl</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">controller</span><span class="p">();</span>
    <span class="p">}));</span>
    <span class="p">...</span>
    <span class="c1">// Tests </span>
    <span class="p">...</span>
<span class="p">});</span></code></pre></figure>

<p>Now we can access the tab-chats DOM through ‘template’. Let’s make sure chats are actually getting listed, the delete button works, and each chat item links to the right view:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">'tab-chats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

   <span class="nx">it</span><span class="p">(</span><span class="s1">'should show a list of chats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

      <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'ion-item'</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">number_of_chats</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">chats</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">number_of_chats</span><span class="p">);</span>

   <span class="p">});</span>

   <span class="nx">it</span><span class="p">(</span><span class="s1">'should call the remove method when delete is tapped'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

      <span class="kd">var</span> <span class="nx">first_item</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'ion-item'</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">first_chat</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">chats</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">first_item</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'ion-option-button'</span><span class="p">);</span>

      <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="s1">'remove'</span><span class="p">);</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">triggerHandler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">remove</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">first_chat</span><span class="p">);</span>

   <span class="p">});</span>

   <span class="nx">it</span><span class="p">(</span><span class="s1">'should link each item to the correct detail view'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

      <span class="kd">var</span> <span class="nx">first_item</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'ion-item'</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">first_chat</span> <span class="o">=</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">chats</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">expected_link</span> <span class="o">=</span> <span class="s1">'#/tab/chats/'</span> <span class="o">+</span> <span class="nx">first_chat</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">first_item</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expected_link</span><span class="p">);</span>
   <span class="p">})</span>
<span class="p">});</span></code></pre></figure>

<h2 id="a-namecordovaa-testing-a-directive-that-uses-an-ng-cordova-plugin-add-contact"><a name="cordova"></a> Testing a directive that uses an ng-cordova plugin: <add-contact></add-contact></h2>
<hr>

<p>Let’s sketch a small directive that adds a chat sender’s name to the device’s contacts. <a href="http://ngcordova.com/">NgCordova</a> comes with its own set of mocks to help you develop in the browser. A nice tutorial for setting up your project to toggle between mock/browser and cordova/device builds can be found <a href="http://justinrodenbostel.com/2015/02/04/getting-started-with-ionic-ngcordova/">here</a>. Fortunately, you can use the mocks in your tests without having to write an intricate build script. Just add them after ng-cordova in the karma.config.js files declaration.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">files</span><span class="p">:</span> <span class="p">[</span>
       <span class="o">...</span>
       <span class="s">"www/lib/ngCordova/dist/ng-cordova.js"</span><span class="p">,</span>
       <span class="s">"www/lib/ngCordova/dist/ng-cordova-mocks.js"</span><span class="p">,</span>
       <span class="o">...</span>    
<span class="p">],</span></code></pre></figure>

<p>Then load the ngCordovaMocks module after your app module at the top of a test. The mock methods will override the real ones.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">'&lt;add-contact&gt;'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="c1">// Load app, cordova mocks</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'starter'</span><span class="p">));</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'ngCordovaMocks'</span><span class="p">));</span>
    
    <span class="c1">// ...</span>
    <span class="c1">// ...</span>

<span class="p">})</span></code></pre></figure>

<p>Here’s our directive template: it’s a footer bar with a button inviting you to add a contact. It’s meant to sit at the bottom of the chats-detail view.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ion-footer-bar</span> <span class="na">align-title=</span><span class="s">"left"</span> <span class="na">class=</span><span class="s">"..."</span> <span class="na">ng-show=</span><span class="s">"!contactAdded"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"title"</span> <span class="nt">&gt;</span>
      <span class="nt">&lt;span&gt;</span> Add  to contacts <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"buttons"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"..."</span> <span class="na">ng-click=</span><span class="s">"createContact()"</span><span class="nt">&gt;&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/ion-footer-bar&gt;</span></code></pre></figure>

<p>And here’s the directive: It binds an object to the ‘contact’ attribute and has a method called ‘createContact’ that uses $cordovaContacts.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'starter'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s2">"addContact"</span><span class="p">,</span> <span class="nx">AddContact</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">AddContact</span><span class="p">(</span><span class="nx">$cordovaContacts</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
       <span class="na">restrict</span><span class="p">:</span> <span class="s1">'E'</span><span class="p">,</span>   
       <span class="na">replace</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
       <span class="na">scope</span><span class="p">:</span> <span class="p">{</span><span class="na">contact</span><span class="p">:</span> <span class="s1">'='</span><span class="p">},</span>
       <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'templates/addContact.html'</span><span class="p">,</span>
      
       <span class="na">link</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">){</span>

          <span class="c1">// Bound to ng-show in the template</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">contactAdded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> 

          <span class="c1">// Bound to ng-click: adds to native contacts</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">createContact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>

            <span class="kd">var</span> <span class="nx">contactInfo</span> <span class="o">=</span><span class="p">{</span> <span class="s2">"displayName"</span><span class="p">:</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">contact</span><span class="p">.</span><span class="nx">name</span> <span class="p">};</span>
            
            <span class="nx">$cordovaContacts</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">contactInfo</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>     
                <span class="nx">scope</span><span class="p">.</span><span class="nx">contactAdded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>        
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">contactAdded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">});</span>    
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
 <span class="p">};</span></code></pre></figure>

<p>This directive is pretty fake but it has all the problems a real one would have: isolate scope, a service dependency that needs to be mocked and code inside a promise callback. We set the test up like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">describe</span><span class="p">(</span><span class="s1">'&lt;add-contact&gt;'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

  <span class="c1">// Locals</span>
  <span class="kd">var</span> <span class="nx">$scope</span><span class="p">,</span> <span class="nx">$compile</span><span class="p">,</span> <span class="nx">$cordovaContacts</span><span class="p">,</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">template</span><span class="p">;</span>

    <span class="c1">// Load app, cordova mocks, and ng-html2js pre-processed templates</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'starter'</span><span class="p">));</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'ngCordovaMocks'</span><span class="p">));</span>
    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">'templates'</span><span class="p">));</span>

  <span class="c1">// Inject services and compile directive</span>
  <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_$rootScope_</span><span class="p">,</span> <span class="nx">_$compile_</span><span class="p">,</span> <span class="nx">_$cordovaContacts_</span><span class="p">,</span> <span class="nx">_Chats_</span> <span class="p">){</span>
        
        <span class="nx">$rootScope</span> <span class="o">=</span> <span class="nx">_$rootScope_</span><span class="p">;</span>
        <span class="nx">$compile</span> <span class="o">=</span> <span class="nx">_$compile_</span><span class="p">;</span>
        <span class="nx">$cordovaContacts</span> <span class="o">=</span> <span class="nx">_$cordovaContacts_</span><span class="p">;</span>
        
        <span class="c1">//Get a chat to pass to the directive</span>
        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">chat</span> <span class="o">=</span> <span class="nx">_Chats_</span><span class="p">.</span><span class="nx">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>

        <span class="c1">// Compile </span>
        <span class="nx">template</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="s1">'&lt;add-contact contact="chat"&gt;&lt;/add-contact&gt;'</span><span class="p">);</span>
        <span class="nx">$compile</span><span class="p">(</span><span class="nx">template</span><span class="p">)(</span><span class="nx">$rootScope</span><span class="p">);</span>
        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

        <span class="c1">// Access directive's scope</span>
        <span class="nx">scope</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">isolateScope</span><span class="p">();</span> 

    <span class="p">}));</span> 

    <span class="c1">// ... Tests ...</span></code></pre></figure>

<p>To mock the ‘contact’ attribute value we’ve created a variable on $rootScope and referenced it in the DOM string that’s getting compiled. Then we’ve accessed the directive’s own scope by calling <a href="https://docs.angularjs.org/api/ng/function/angular.element">angular.element’s</a> isolateScope() on the compiled directive. Let’s test the button:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">it</span><span class="p">(</span><span class="s1">'should create a contact when the user taps the plus button'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

  <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'button'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">expected_contact</span> <span class="o">=</span> <span class="p">{</span> <span class="na">displayName</span><span class="p">:</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">name</span> <span class="p">};</span>

  <span class="nx">spyOn</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s1">'createContact'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">callThrough</span><span class="p">();</span>
  <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$cordovaContacts</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">callThrough</span><span class="p">();</span>

  <span class="nx">button</span><span class="p">.</span><span class="nx">triggerHandler</span><span class="p">(</span><span class="s1">'click'</span><span class="p">);</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">$cordovaContacts</span><span class="p">.</span><span class="nx">save</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">expected_contact</span><span class="p">);</span>

<span class="p">})</span></code></pre></figure>

<p>Using Jasmine’s callThrough method we can go from the button element down to the core of createContact() and verify that $cordovaContacts gets called with the correct data. ($cordovaContacts has to be called through as well or the underlying code will throw an error when it hits the ‘then’ statement).</p>

<p>Let’s test the code inside the promise callback and use an ng-cordova-mocks feature that lets you emulate callback error by setting a service’s ‘throwsError’ field to ‘true’:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">it</span><span class="p">(</span><span class="s1">'should hide itself after adding a contact'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

  <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$cordovaContacts</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">callThrough</span><span class="p">();</span>

  <span class="nx">scope</span><span class="p">.</span><span class="nx">createContact</span><span class="p">();</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">'ng-hide'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="p">});</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">'should NOT hide itself if adding contact failed'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

  <span class="nx">$cordovaContacts</span><span class="p">.</span><span class="nx">throwsError</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$cordovaContacts</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">callThrough</span><span class="p">();</span>

  <span class="nx">scope</span><span class="p">.</span><span class="nx">createContact</span><span class="p">();</span>
  <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">'ng-hide'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="p">})</span></code></pre></figure>

<h2 id="run-the-tests">Run the tests</h2>

<p>Run <code class="highlighter-rouge">$ gulp test</code> to see the report:</p>

<p><img src="./Ionic_Karma Guide_files/chatstest1.png" alt="Test Report for ChatsCtrl" class="center-image"></p>

<h2 id="contact">Contact</h2>
<hr>
<p>Feel free to ask questions or make suggestions via the <a href="https://github.com/cgewecke/ionic-karma-guide/issues">issues</a> page for this project. There are no special guidelines - just open an issue and write.</p>


</article>




</div>

</div><!-- .container -->



</body></html>